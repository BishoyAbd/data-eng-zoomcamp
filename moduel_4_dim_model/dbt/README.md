
# **Project Setup with PostgreSQL, pgAdmin, and dbt**

This document outlines the steps to set up **PostgreSQL**, **pgAdmin**, and **dbt** in a Docker environment, structure your dbt project, and run and update transformations.

## **1. Docker Compose Setup for PostgreSQL and pgAdmin**

### **Docker Compose File**

This `docker-compose.yml` file creates containers for PostgreSQL and pgAdmin, both running on the same network for easy interaction.

```yaml
version: '3.8'

services:
  postgres:
    image: postgres:latest
    container_name: postgres_container
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres_password
      POSTGRES_DB: postgres_db
    ports:
      - "5432:5432"
    networks:
      - postgres_network

  pgadmin:
    image: dpage/pgadmin4
    container_name: pgadmin_container
    environment:
      PGADMIN_DEFAULT_EMAIL: admin@admin.com
      PGADMIN_DEFAULT_PASSWORD: admin
    ports:
      - "8080:80"
    depends_on:
      - postgres
    networks:
      - postgres_network

networks:
  postgres_network:
    driver: bridge
```

### **Steps to Run PostgreSQL and pgAdmin**

1. **Create the `docker-compose.yml` file** in your project directory with the content above.
2. **Run the containers** using Docker Compose:

   ```bash
   docker-compose up -d
   ```

3. **Access pgAdmin**:
   - Open your browser and go to `http://localhost:8080`.
   - Login with the default email and password set in `docker-compose.yml` (`admin@admin.com`, `admin`).
   - Add a new server in pgAdmin and connect to `postgres_container` using the following:
     - **Host**: `postgres_container`
     - **Port**: `5432`
     - **Username**: `postgres`
     - **Password**: `postgres_password`

---

## **2. Setting Up dbt**

### **Step 1: Create a Dockerfile for dbt**

Create a `Dockerfile` in the same directory as your `docker-compose.yml` to build the dbt container.

```Dockerfile
# Use a lightweight Python image
FROM python:3.9-slim

# Set the working directory
WORKDIR /usr/app

# Install dbt and the Postgres adapter
RUN pip install --upgrade pip && pip install dbt-core dbt-postgres

# Copy the project files into the container
COPY . .

# Set environment variable for profiles.yml
ENV DBT_PROFILES_DIR=/usr/app/.dbt

# Default command to run dbt
CMD ["dbt", "run"]
```

### **Step 2: Update `docker-compose.yml` to Include dbt**

Add the following service for dbt to the `docker-compose.yml`:

```yaml
  dbt:
    build: .
    container_name: dbt_container
    volumes:
      - .:/usr/app
    networks:
      - postgres_network
    environment:
      - DBT_PROFILES_DIR=/usr/app/.dbt
    depends_on:
      - postgres
```

### **Step 3: Set Up `profiles.yml` for dbt**

In your project directory, create a `.dbt/` folder, and inside it, create a `profiles.yml` file with the following content:

```yaml
my_dbt_project:
  target: dev
  outputs:
    dev:
      type: postgres
      host: postgres_container  # PostgreSQL container name
      user: postgres
      password: postgres_password
      port: 5432
      dbname: postgres_db
      schema: public
      threads: 4
```

- **host**: Set this to the name of your PostgreSQL container (`postgres_container`).
- **user**: The username for PostgreSQL (in this case, `postgres`).
- **password**: Password for the PostgreSQL user.
- **dbname**: The name of the database where dbt will operate.
- **schema**: The schema where dbt models will be created (default: `public`).
- **threads**: Number of parallel threads dbt will use to run models.

> **Note**: If you’re using a separate network for PostgreSQL and dbt, change the `host` to `host.docker.internal` for cross-container communication.

### **Step 4: Edit `dbt_project.yml`**

Inside the `dbt_project.yml` file (auto-generated by dbt), specify the profile and add your basic configurations:

```yaml
name: 'my_dbt_project'
version: '1.0'
config-version: 2

profile: my_dbt_project  # Must match the profile name in profiles.yml

model-paths: ["models"]

models:
  my_dbt_project:
    # +schema: public
    +materialized: view  # Options: view, table, incremental
```

### **Step 5: Initialize Your dbt Project**


0. Build the container

   ```bash
   docker-compose build  # neccessary in case you update the Dockerfile
   ```
    

1. Start the Docker Compose services:

   ```bash
   docker-compose up -d
   ```


### **Step 6: Create Your First Model**

1. Inside the `models/` directory, create a new SQL file called `yellow_taxi_summary.sql`:

   ```sql
   -- models/yellow_taxi_summary.sql
   SELECT
     passenger_count,
     SUM(total_amount) AS total_fare,
     COUNT(*) AS total_rides
   FROM
     ny_taxi_data
   GROUP BY
     passenger_count
   ```

### **Step 7: Running dbt**

To run your dbt models, use the following commands:

1. **Build the dbt container**:

   ```bash
   docker-compose build dbt
   ```

2. **Run dbt**:

   ```bash
   docker-compose up dbt
   ```

This will execute the `yellow_taxi_summary.sql` model and create the corresponding view in your PostgreSQL database.

### **Step 8: Adding New Models and Rerunning dbt**

1. To add a new transformation, simply create another SQL file in the `models/` directory.
   - For example, you can create `daily_summary.sql` to summarize the taxi data on a daily basis.

2. **Example of a New Model**:

   ```sql
   -- models/daily_summary.sql
   SELECT
     DATE(tpep_pickup_datetime) AS pickup_date,
     COUNT(*) AS total_rides,
     SUM(total_amount) AS total_fare
   FROM
     ny_taxi_data
   GROUP BY
     pickup_date
   ```

3. **Rerun dbt**:
   After adding the new model, rerun the dbt transformations:

   ```bash
   docker-compose up dbt
   ```

---

## **3. Project Directory Structure**

After following the steps, your project structure should look something like this:

```bash
my_dbt_project/
│
├── .dbt/
│   └── profiles.yml          # dbt connection configuration
│
├── models/
│   ├── yellow_taxi_summary.sql  # First model to summarize taxi data by passenger count
│   └── daily_summary.sql        # Another model to summarize taxi data by date
│
├── Dockerfile                # Dockerfile to create dbt container
├── docker-compose.yml        # Docker Compose file for dbt, PostgreSQL, and pgAdmin
├── dbt_project.yml           # Main dbt project configuration
└── README.md                 # This documentation
```

---

### **Final Notes**
- **pgAdmin** can be accessed at `http://localhost:8080`, and you can manage your PostgreSQL database from there.
- **dbt** is managed through Docker and can be rerun any time to apply transformations.
- Adding new SQL models is simple—just place them in the `models/` folder and rerun dbt.


---
